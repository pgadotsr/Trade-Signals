<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Signal Dashboard â€” Debug</title>
  <style>
    body { background: #111; color: white; font-family: sans-serif; padding: 10px; }
    .error { background: #600; padding: 10px; margin-top: 10px; white-space: pre-wrap; }
    pre { background: #222; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h2>ðŸ“Š Trade Signal Dashboard â€” Debug</h2>
  <label><input type="checkbox" id="demoMode" checked> Demo mode</label>
  <br><br>
  Asset: 
  <select id="asset">
    <option>EUR/USD</option>
    <option>GBP/USD</option>
  </select>
  Period:
  <select id="period">
    <option value="15m">15m</option>
    <option value="1h">1h</option>
  </select>

  <p>Status: <span id="status">script startingâ€¦</span></p>
  <p>Bars: <span id="barCount">-</span> â€¢ Last time: <span id="lastTime">-</span></p>
  <p>Fetching URL: <span id="fetchUrl">-</span></p>
  <p>Demo flag from API: <span id="apiDemo">-</span></p>
  <p>API/JS error log:</p>
  <div id="errorLog" class="error"></div>
  <p>First 3 bars:</p>
  <pre id="barsPreview">-</pre>

  <div id="chart" style="height:400px;"></div>

  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const barCountEl = document.getElementById('barCount');
    const lastTimeEl = document.getElementById('lastTime');
    const fetchUrlEl = document.getElementById('fetchUrl');
    const apiDemoEl = document.getElementById('apiDemo');
    const errorLogEl = document.getElementById('errorLog');
    const barsPreviewEl = document.getElementById('barsPreview');

    function logError(err) {
      errorLogEl.textContent = err.toString();
    }

    async function fetchData() {
      statusEl.textContent = "script running";

      const asset = document.getElementById('asset').value;
      const period = document.getElementById('period').value;
      const demo = document.getElementById('demoMode').checked;
      const url = `/api/data?asset=${encodeURIComponent(asset)}&period=${encodeURIComponent(period)}&demo=${demo}`;
      fetchUrlEl.textContent = url;

      try {
        const res = await fetch(url);
        const data = await res.json();

        apiDemoEl.textContent = data.demo || false;
        barCountEl.textContent = data.ohlc?.length || 0;

        if (data.ohlc?.length) {
          lastTimeEl.textContent = data.ohlc[data.ohlc.length - 1].time;
          barsPreviewEl.textContent = JSON.stringify(data.ohlc.slice(0, 3), null, 2);
        }

        try {
          const chart = LightweightCharts.createChart(document.getElementById('chart'), { width: 600, height: 400 });
          if (chart.addCandlestickSeries) {
            const candleSeries = chart.addCandlestickSeries();
            candleSeries.setData(data.ohlc.map(b => ({
              time: b.time,
              open: b.open,
              high: b.high,
              low: b.low,
              close: b.close
            })));
          } else {
            throw new Error("Candlestick function missing in LightweightCharts");
          }
        } catch (chartErr) {
          logError("JS Error: " + chartErr.message + "\n\n" + chartErr.stack);
        }

      } catch (err) {
        logError("API fetch error: " + err);
      }
    }

    fetchData();
  </script>
</body>
</html>
