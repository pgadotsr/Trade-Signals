<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Signal Dashboard â€” Fixed</title>
  <style>
    body { background:#0e1116; color:#eaeaea; font-family: system-ui, Arial, sans-serif; margin:0; }
    header { padding:12px 16px; display:flex; gap:10px; align-items:center; border-bottom:1px solid #222; }
    select, input[type=checkbox] { accent-color:#6ea8fe; }
    #chart { height: 520px; margin:12px 16px; }
    #info, #debug { margin:12px 16px; }
    #error { background:#2a1111; border:1px solid #552222; padding:10px; border-radius:8px; display:none; white-space:pre-wrap; }
    pre { background:#0b0e14; border:1px solid #222; border-radius:8px; padding:8px; overflow:auto; }
  </style>
  <!-- Pin Lightweight Charts to a known-good version -->
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <header>
    <h3 style="margin:0 12px 0 0;">ðŸ“Š Trade Signal Dashboard</h3>
    <label>Asset:
      <select id="asset">
        <option>EUR/USD</option>
        <option>GBP/USD</option>
        <option>Gold</option>
        <option>Silver</option>
        <option>Bitcoin</option>
        <option>Tesla</option>
      </select>
    </label>
    <label>Period:
      <select id="period">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m" selected>15m</option>
      </select>
    </label>
    <button data-range="1D" class="range">1 Day</button>
    <button data-range="1W" class="range">1 Week</button>
    <button data-range="1M" class="range">1 Month</button>
    <label style="margin-left:12px;"><input id="demo" type="checkbox" checked> Demo mode</label>
    <div style="flex:1"></div>
    <span>Auto-refresh: 5s</span>
  </header>

  <div id="info">Bars: <b id="barCount">0</b> â€¢ Last time: <b id="lastTime">â€”</b></div>
  <div id="debug">
    Fetching URL: <span id="fetchUrl">â€”</span><br/>
    Demo flag from API: <span id="apiDemo">â€”</span>
    <div id="error"></div>
    <div>First 3 bars:</div>
    <pre id="barsPreview">â€”</pre>
  </div>

  <div id="chart"></div>

  <script>
    const el = id => document.getElementById(id);
    const assetSel = el('asset'), periodSel = el('period');
    const demoChk = el('demo'); const fetchUrlEl = el('fetchUrl');
    const apiDemoEl = el('apiDemo'); const errBox = el('error');
    const barCountEl = el('barCount'); const lastTimeEl = el('lastTime');
    const barsPreviewEl = el('barsPreview');
    const rangeBtns = Array.from(document.querySelectorAll('button.range'));
    let currentRange = '1D', timer = null;

    function setRange(r){ currentRange = r; refresh(); }
    rangeBtns.forEach(b => b.onclick = () => setRange(b.dataset.range));
    assetSel.onchange = periodSel.onchange = demoChk.onchange = refresh;

    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
      layout:{ background:{ type:'solid', color:'#0e1116' }, textColor:'#d0d0d0' },
      rightPriceScale:{ borderColor:'#2a2f3a' },
      timeScale:{ borderColor:'#2a2f3a' },
      grid:{ horzLines:{ color:'#1a1f28' }, vertLines:{ color:'#1a1f28' } }
    });
    const candles = chart.addCandlestickSeries();

    async function refresh(){
      errBox.style.display='none'; errBox.textContent='';
      const asset = assetSel.value;
      const timeframe = periodSel.value;          // <-- backend expects "timeframe"
      const demo = demoChk.checked ? '&demo=1' : '';
      const url = `/api/signal?asset=${encodeURIComponent(asset)}&timeframe=${encodeURIComponent(timeframe)}&range=${encodeURIComponent(currentRange)}${demo}`;
      fetchUrlEl.textContent = url;

      try{
        const res = await fetch(url, { cache:'no-store' });
        // If server returned HTML (e.g., 404), this will throw â†’ caught below
        const data = await res.json();

        apiDemoEl.textContent = data.demo ? 'true' : 'false';

        const bars = (data.ohlc||[]).map(d => ({
          time:Number(d.time), open:Number(d.open), high:Number(d.high), low:Number(d.low), close:Number(d.close)
        }));

        barCountEl.textContent = bars.length;
        lastTimeEl.textContent = bars.length ? new Date(bars[bars.length-1].time*1000).toLocaleString() : 'â€”';
        barsPreviewEl.textContent = bars.length ? JSON.stringify(bars.slice(0,3), null, 2) : 'â€”';

        candles.setData(bars);
        chart.timeScale().fitContent();
      }catch(e){
        errBox.style.display='block';
        errBox.textContent = 'API/Parse error: ' + e;
      }
    }

    // init
    setRange('1D');
    timer = setInterval(refresh, 5000);
    refresh();
  </script>
</body>
</html>
